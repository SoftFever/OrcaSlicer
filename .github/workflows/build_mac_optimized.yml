name: Build Mac (Optimized)

on:
  workflow_dispatch: # Manual trigger only
    inputs:
      skip-sync:
        description: 'Skip upstream sync'
        type: boolean
        default: false
      force-rebuild:
        description: 'Force rebuild (ignore build cache)'
        type: boolean
        default: false

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  sync_upstream:
    name: Sync from Upstream
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/cyberralf83/orcanightly' && !inputs.skip-sync

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          ref: cyberralf83/orcanightly
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/SoftFever/OrcaSlicer.git || true
          git remote -v

      - name: Fetch upstream nightly-builds tag
        run: |
          git fetch upstream --tags
          git tag -l "nightly-builds"

      - name: Merge upstream changes
        run: |
          echo "Attempting to merge nightly-builds tag from upstream into cyberralf83/orcanightly..."
          if git merge nightly-builds --no-edit; then
            echo "âœ… Merge successful!"
          else
            echo "âŒ MERGE CONFLICT DETECTED!"
            echo "Please resolve conflicts manually"
            git merge --abort
            exit 1
          fi

      - name: Push merged changes
        run: |
          git push origin cyberralf83/orcanightly

  build_mac_optimized:
    name: Build macOS (with caching)
    needs: [sync_upstream]
    if: |
      always() &&
      (needs.sync_upstream.result == 'success' ||
       needs.sync_upstream.result == 'skipped')
    runs-on: macos-14
    env:
      date:
      ver:
      ver_pure:
      ORCA_UPDATER_SIG_KEY: ${{ secrets.ORCA_UPDATER_SIG_KEY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          lfs: 'true'

      - uses: lukka/get-cmake@latest
        with:
          cmakeVersion: "~3.28.0"

      # ============================================
      # DEPENDENCY CACHE (existing logic)
      # ============================================
      - name: Compute dependency cache key
        id: deps_cache_key
        run: |
          DEPS_HASH=$(find deps -type f -exec shasum {} \; | shasum | cut -d' ' -f1)
          echo "key=macos-14-deps-${DEPS_HASH}" >> $GITHUB_OUTPUT
          echo "path=${{ github.workspace }}/deps/build" >> $GITHUB_OUTPUT

      - name: Restore dependency cache
        id: deps_cache
        uses: actions/cache@v4
        with:
          path: ${{ steps.deps_cache_key.outputs.path }}
          key: ${{ steps.deps_cache_key.outputs.key }}

      - name: Install build tools for deps
        if: steps.deps_cache.outputs.cache-hit != 'true'
        run: |
          brew install automake texinfo libtool
          brew list
          brew uninstall --ignore-dependencies zstd

      - name: Build dependencies
        if: steps.deps_cache.outputs.cache-hit != 'true'
        working-directory: ${{ github.workspace }}
        run: |
          ./build_release_macos.sh -dx -a universal -t 10.15 -1
          for arch in arm64 x86_64; do
              (cd "${{ github.workspace }}/deps/build/${arch}" && \
              find . -mindepth 1 -maxdepth 1 ! -name 'OrcaSlicer_dep' -exec rm -rf {} +)
          done

      - name: Reinstall zstd
        if: steps.deps_cache.outputs.cache-hit != 'true'
        run: brew install zstd

      # ============================================
      # BUILD ARTIFACT CACHE (NEW - optimization)
      # ============================================
      - name: Compute build cache key
        id: build_cache_key
        run: |
          # Hash source files that affect build output
          SRC_HASH=$(find src -type f \( -name "*.cpp" -o -name "*.hpp" -o -name "*.h" -o -name "*.c" -o -name "*.mm" \) -exec shasum {} \; | shasum | cut -d' ' -f1)
          CMAKE_HASH=$(find . -name "CMakeLists.txt" -exec shasum {} \; | shasum | cut -d' ' -f1)
          VERSION_HASH=$(shasum version.inc | cut -d' ' -f1)
          LOC_HASH=$(find localization -type f -exec shasum {} \; 2>/dev/null | shasum | cut -d' ' -f1 || echo "none")
          RES_HASH=$(find resources -type f \( -name "*.cpp" -o -name "*.hpp" \) -exec shasum {} \; 2>/dev/null | shasum | cut -d' ' -f1 || echo "none")

          COMBINED_HASH=$(echo "${SRC_HASH}${CMAKE_HASH}${VERSION_HASH}${LOC_HASH}${RES_HASH}" | shasum | cut -d' ' -f1)

          echo "key=macos-14-arm64-build-${COMBINED_HASH}" >> $GITHUB_OUTPUT
          echo "path=${{ github.workspace }}/build/arm64" >> $GITHUB_OUTPUT
          echo "Build cache key: macos-14-arm64-build-${COMBINED_HASH}"

      - name: Restore build cache
        if: ${{ !inputs.force-rebuild }}
        id: build_cache
        uses: actions/cache@v4
        with:
          path: ${{ steps.build_cache_key.outputs.path }}
          key: ${{ steps.build_cache_key.outputs.key }}

      - name: Cache status
        run: |
          echo "Dependencies cache hit: ${{ steps.deps_cache.outputs.cache-hit }}"
          echo "Build cache hit: ${{ steps.build_cache.outputs.cache-hit }}"
          if [[ "${{ steps.build_cache.outputs.cache-hit }}" == "true" ]]; then
            echo "âœ… Build artifacts found in cache - skipping compilation!"
          else
            echo "ðŸ”¨ No build cache found - will compile from source"
          fi

      # ============================================
      # BUILD SLICER (conditional on cache miss)
      # ============================================
      - name: Get version and date
        run: |
          ver_pure=$(grep 'set(SoftFever_VERSION' version.inc | cut -d '"' -f2)
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            ver="PR-${{ github.event.number }}"
            git_commit_hash="${{ github.event.pull_request.head.sha }}"
          else
            ver=V$ver_pure
            git_commit_hash=""
          fi
          echo "ver=$ver" >> $GITHUB_ENV
          echo "ver_pure=$ver_pure" >> $GITHUB_ENV
          echo "date=$(date +'%Y%m%d')" >> $GITHUB_ENV
          echo "git_commit_hash=$git_commit_hash" >> $GITHUB_ENV
        shell: bash

      - name: Install tools for build
        run: |
          brew install libtool
          brew list
          mkdir -p ${{ github.workspace }}/deps/build

      - name: Free disk space
        run: |
          df -hI /dev/disk3s1s1
          sudo find /Applications -maxdepth 1 -type d -name "Xcode_*.app" ! -name "Xcode_15.4.app" -exec rm -rf {} +
          sudo rm -rf ~/Library/Developer/CoreSimulator/Caches/*
          df -hI /dev/disk3s1s1

      - name: Build slicer
        if: steps.build_cache.outputs.cache-hit != 'true' || inputs.force-rebuild
        working-directory: ${{ github.workspace }}
        run: |
          echo "ðŸ”¨ Building OrcaSlicer from source..."
          ./build_release_macos.sh -s -n -x -a arm64 -t 10.15 -1

      - name: Build cache save
        if: steps.build_cache.outputs.cache-hit != 'true' && !inputs.force-rebuild
        uses: actions/cache/save@v4
        with:
          path: ${{ steps.build_cache_key.outputs.path }}
          key: ${{ steps.build_cache_key.outputs.key }}

      # ============================================
      # SIGN, PACKAGE, AND DEPLOY
      # ============================================
      - name: Sign app and notarize
        if: (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/cyberralf83/orcanightly' || startsWith(github.ref, 'refs/heads/release/'))
        working-directory: ${{ github.workspace }}
        env:
          BUILD_CERTIFICATE_BASE64: ${{ secrets.BUILD_CERTIFICATE_BASE64 }}
          P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
          CERTIFICATE_ID: ${{ secrets.MACOS_CERTIFICATE_ID }}
        run: |
          CERTIFICATE_PATH=$RUNNER_TEMP/build_certificate.p12
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          echo -n "$BUILD_CERTIFICATE_BASE64" | base64 --decode --output $CERTIFICATE_PATH
          security create-keychain -p $KEYCHAIN_PASSWORD $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p $KEYCHAIN_PASSWORD $KEYCHAIN_PATH
          security import $CERTIFICATE_PATH -P $P12_PASSWORD -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k $P12_PASSWORD $KEYCHAIN_PATH
          codesign --deep --force --verbose --options runtime --timestamp --entitlements ${{ github.workspace }}/scripts/disable_validation.entitlements --sign "$CERTIFICATE_ID" ${{ github.workspace }}/build/arm64/OrcaSlicer/OrcaSlicer.app

          # Sign profile validator if it exists
          if [ -f "${{ github.workspace }}/build/arm64/OrcaSlicer/OrcaSlicer_profile_validator.app/Contents/MacOS/OrcaSlicer_profile_validator" ]; then
            codesign --deep --force --verbose --options runtime --timestamp --entitlements ${{ github.workspace }}/scripts/disable_validation.entitlements --sign "$CERTIFICATE_ID" ${{ github.workspace }}/build/arm64/OrcaSlicer/OrcaSlicer_profile_validator.app
          fi

          # Create main DMG
          mkdir -p ${{ github.workspace }}/build/arm64/OrcaSlicer_dmg
          rm -rf ${{ github.workspace }}/build/arm64/OrcaSlicer_dmg/*
          cp -R ${{ github.workspace }}/build/arm64/OrcaSlicer/OrcaSlicer.app ${{ github.workspace }}/build/arm64/OrcaSlicer_dmg/
          ln -sfn /Applications ${{ github.workspace }}/build/arm64/OrcaSlicer_dmg/Applications
          hdiutil create -volname "OrcaSlicer" -srcfolder ${{ github.workspace }}/build/arm64/OrcaSlicer_dmg -ov -format UDZO OrcaSlicer_Mac_arm64_${{ env.ver }}.dmg
          codesign --deep --force --verbose --options runtime --timestamp --entitlements ${{ github.workspace }}/scripts/disable_validation.entitlements --sign "$CERTIFICATE_ID" OrcaSlicer_Mac_arm64_${{ env.ver }}.dmg

          # Create profile validator DMG if it exists
          if [ -f "${{ github.workspace }}/build/arm64/OrcaSlicer/OrcaSlicer_profile_validator.app/Contents/MacOS/OrcaSlicer_profile_validator" ]; then
            mkdir -p ${{ github.workspace }}/build/arm64/OrcaSlicer_profile_validator_dmg
            rm -rf ${{ github.workspace }}/build/arm64/OrcaSlicer_profile_validator_dmg/*
            cp -R ${{ github.workspace }}/build/arm64/OrcaSlicer/OrcaSlicer_profile_validator.app ${{ github.workspace }}/build/arm64/OrcaSlicer_profile_validator_dmg/
            ln -sfn /Applications ${{ github.workspace }}/build/arm64/OrcaSlicer_profile_validator_dmg/Applications
            hdiutil create -volname "OrcaSlicer Profile Validator" -srcfolder ${{ github.workspace }}/build/arm64/OrcaSlicer_profile_validator_dmg -ov -format UDZO OrcaSlicer_profile_validator_Mac_arm64_${{ env.ver }}.dmg
            codesign --deep --force --verbose --options runtime --timestamp --entitlements ${{ github.workspace }}/scripts/disable_validation.entitlements --sign "$CERTIFICATE_ID" OrcaSlicer_profile_validator_Mac_arm64_${{ env.ver }}.dmg
          fi

          # Notarize main DMG
          xcrun notarytool store-credentials "notarytool-profile" --apple-id "${{ secrets.APPLE_DEV_ACCOUNT }}" --team-id "${{ secrets.TEAM_ID }}" --password "${{ secrets.APP_PWD }}"
          xcrun notarytool submit "OrcaSlicer_Mac_arm64_${{ env.ver }}.dmg" --keychain-profile "notarytool-profile" --wait
          xcrun stapler staple OrcaSlicer_Mac_arm64_${{ env.ver }}.dmg

          # Notarize profile validator DMG if it exists
          if [ -f "OrcaSlicer_profile_validator_Mac_arm64_${{ env.ver }}.dmg" ]; then
            xcrun notarytool submit "OrcaSlicer_profile_validator_Mac_arm64_${{ env.ver }}.dmg" --keychain-profile "notarytool-profile" --wait
            xcrun stapler staple OrcaSlicer_profile_validator_Mac_arm64_${{ env.ver }}.dmg
          fi

      - name: Create DMG without notarization
        if: github.ref != 'refs/heads/main' && github.ref != 'refs/heads/cyberralf83/orcanightly'
        working-directory: ${{ github.workspace }}
        run: |
          mkdir -p ${{ github.workspace }}/build/arm64/OrcaSlicer_dmg
          rm -rf ${{ github.workspace }}/build/arm64/OrcaSlicer_dmg/*
          cp -R ${{ github.workspace }}/build/arm64/OrcaSlicer/OrcaSlicer.app ${{ github.workspace }}/build/arm64/OrcaSlicer_dmg/
          ln -sfn /Applications ${{ github.workspace }}/build/arm64/OrcaSlicer_dmg/Applications
          hdiutil create -volname "OrcaSlicer" -srcfolder ${{ github.workspace }}/build/arm64/OrcaSlicer_dmg -ov -format UDZO OrcaSlicer_Mac_arm64_${{ env.ver }}.dmg

          # Create profile validator DMG if it exists
          if [ -f "${{ github.workspace }}/build/arm64/OrcaSlicer/OrcaSlicer_profile_validator.app/Contents/MacOS/OrcaSlicer_profile_validator" ]; then
            mkdir -p ${{ github.workspace }}/build/arm64/OrcaSlicer_profile_validator_dmg
            rm -rf ${{ github.workspace }}/build/arm64/OrcaSlicer_profile_validator_dmg/*
            cp -R ${{ github.workspace }}/build/arm64/OrcaSlicer/OrcaSlicer_profile_validator.app ${{ github.workspace }}/build/arm64/OrcaSlicer_profile_validator_dmg/
            ln -sfn /Applications ${{ github.workspace }}/build/arm64/OrcaSlicer_profile_validator_dmg/Applications
            hdiutil create -volname "OrcaSlicer Profile Validator" -srcfolder ${{ github.workspace }}/build/arm64/OrcaSlicer_profile_validator_dmg -ov -format UDZO OrcaSlicer_profile_validator_Mac_arm64_${{ env.ver }}.dmg
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: OrcaSlicer_Mac_arm64_${{ env.ver }}_optimized
          path: ${{ github.workspace }}/OrcaSlicer_Mac_arm64_${{ env.ver }}.dmg

      - name: Upload profile validator DMG
        uses: actions/upload-artifact@v4
        with:
          name: OrcaSlicer_profile_validator_Mac_arm64_DMG_${{ env.ver }}_optimized
          path: ${{ github.workspace }}/OrcaSlicer_profile_validator_Mac_arm64_${{ env.ver }}.dmg
          if-no-files-found: ignore

      - name: Deploy Mac release
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/cyberralf83/orcanightly'
        uses: WebFreak001/deploy-nightly@v3.2.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: https://uploads.github.com/repos/cyberralf83/OrcaSlicer/releases/${{ secrets.MAC_RELEASE_ID }}/assets{?name,label}
          release_id: ${{ secrets.MAC_RELEASE_ID }}
          asset_path: ${{ github.workspace }}/OrcaSlicer_Mac_arm64_${{ env.ver }}.dmg
          asset_name: OrcaSlicer_Mac_arm64_nightly.dmg
          asset_content_type: application/octet-stream
          max_releases: 1

      - name: Deploy Mac profile validator DMG release
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/cyberralf83/orcanightly'
        uses: WebFreak001/deploy-nightly@v3.2.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: https://uploads.github.com/repos/cyberralf83/OrcaSlicer/releases/${{ secrets.MAC_RELEASE_ID }}/assets{?name,label}
          release_id: ${{ secrets.MAC_RELEASE_ID }}
          asset_path: ${{ github.workspace }}/OrcaSlicer_profile_validator_Mac_arm64_${{ env.ver }}.dmg
          asset_name: OrcaSlicer_profile_validator_Mac_arm64_nightly.dmg
          asset_content_type: application/octet-stream
          max_releases: 1
