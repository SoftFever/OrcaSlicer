name: Check Translation Consistency

on:
  schedule:
    - cron: '0 0 * * *' # æ¯å¤©åŸ·è¡Œ
  workflow_dispatch: # å…è¨±æ‰‹å‹•è§¸ç™¼

jobs:
  check-translation:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸš€ æª¢æŸ¥ä¸¦åŒæ­¥å€‰åº«
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: ğŸ”„ å–å¾—ä¸Šæ¸¸ç¿»è­¯æ–‡ä»¶
        run: |
          git remote add upstream https://github.com/SoftFever/OrcaSlicer.git || true
          git fetch upstream main

      - name: ğŸ” æ¯”å°ç¿»è­¯æ–‡ä»¶å·®ç•°
        run: |
          DIFF_FILES=""
          DIFF_SUMMARY=""

          if ! git diff --quiet upstream/main -- localization/i18n/zh_TW/OrcaSlicer_zh_TW.po; then
            DIFF_FILES="$DIFF_FILES localization/i18n/zh_TW/OrcaSlicer_zh_TW.po"
            DIFF_SUMMARY+="| ğŸ“„ localization/i18n/zh_TW/OrcaSlicer_zh_TW.po | $(git diff --shortstat upstream/main -- localization/i18n/zh_TW/OrcaSlicer_zh_TW.po) |
            "
          fi
          if ! git diff --quiet upstream/main -- localization/i18n/OrcaSlicer.pot; then
            DIFF_FILES="$DIFF_FILES localization/i18n/OrcaSlicer.pot"
            DIFF_SUMMARY+="| ğŸ“„ localization/i18n/OrcaSlicer.pot | $(git diff --shortstat upstream/main -- localization/i18n/OrcaSlicer.pot) |
            "
          fi

          if [[ -n "$DIFF_FILES" ]]; then
            echo "ğŸ”„ æª”æ¡ˆä¸ä¸€è‡´: $DIFF_FILES"
            echo "changed=true" >> $GITHUB_ENV
            echo "diff_files=\"$DIFF_FILES\"" >> $GITHUB_ENV
            printf "diff_summary<<EOF\n%s\nEOF\n" "$DIFF_SUMMARY" >> $GITHUB_ENV
          else
            echo "âœ… æª”æ¡ˆä¸€è‡´ï¼Œç„¡éœ€åŒæ­¥"
            echo "changed=false" >> $GITHUB_ENV
          fi

      - name: ğŸ” ç¢ºä¿ "translation" æ¨™ç±¤å­˜åœ¨
        run: |
          echo "ğŸ” æª¢æŸ¥æ˜¯å¦å·²æœ‰ 'translation' æ¨™ç±¤..."
          LABELS=$(gh label list --repo shuwn/OrcaSlicer --json name --jq '.[].name' || true)
          if [[ ! "$LABELS" =~ "translation" ]]; then
            echo "â• å‰µå»º 'translation' æ¨™ç±¤"
            gh label create "translation" --repo shuwn/OrcaSlicer --description "ç¿»è­¯åŒæ­¥ç›¸é—œè­°é¡Œ"
          else
            echo "âœ… 'translation' æ¨™ç±¤å·²å­˜åœ¨"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“ å‰µå»ºæˆ–æ›´æ–° Issue
        if: env.changed == 'true'
        run: |
          echo "ğŸ” æª¢æŸ¥æ˜¯å¦å·²æœ‰æœªè§£æ±ºçš„ç¿»è­¯å•é¡Œ..."
          ISSUE_NUMBER=$(gh issue list --repo shuwn/OrcaSlicer --state open --label "translation" --json number --jq '.[0].number' || true)

          ISSUE_BODY=$(printf "**ğŸ”„ ç¿»è­¯æª”æ¡ˆåŒæ­¥é€šçŸ¥**\n\n
          ğŸ”— **ä¸Šæ¸¸å€‰åº«**: [SoftFever/OrcaSlicer](https://github.com/SoftFever/OrcaSlicer)\n\n
          ğŸ”¹ **å½±éŸ¿çš„æª”æ¡ˆ**:\n\n
          | æ–‡ä»¶åç¨± | è®Šæ›´æ‘˜è¦ |
          |----------|---------|
          %s\n\n
          ğŸ”„ **è«‹ç¢ºèªæ˜¯å¦éœ€è¦åŒæ­¥æ›´æ–°ï¼**\n
          ğŸ” **å¦‚å·²åŒæ­¥ï¼Œè«‹é—œé–‰æ­¤ Issue** ğŸ™Œ" \
          "${{ env.diff_summary }}")

          if [[ -n "$ISSUE_NUMBER" ]]; then
            echo "ğŸ“ å·²æœ‰ Issue #$ISSUE_NUMBERï¼Œæ–°å¢ç•™è¨€è£œå……è®Šæ›´..."
            gh issue comment "$ISSUE_NUMBER" --repo shuwn/OrcaSlicer --body "$ISSUE_BODY"
          else
            echo "ğŸš€ å‰µå»ºæ–° Issue..."
            gh issue create --repo shuwn/OrcaSlicer \
              --title "âš ï¸ ç¿»è­¯æª”æ¡ˆèˆ‡ä¸Šæ¸¸ä¸åŒï¼" \
              --body "$ISSUE_BODY" \
              --label "translation"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}